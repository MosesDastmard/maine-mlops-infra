# Kustomize overlay for Kubeflow Pipelines 2.14.4
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mlops-kubeflow

resources:
  - github.com/kubeflow/pipelines//manifests/kustomize/env/platform-agnostic-emissary?ref=2.14.4
  - namespace.yml
  - rbac.yml
  - webhook-tls-secret.yml

replacements:
  - source:
      kind: Namespace
      name: mlops-kubeflow
      fieldPath: metadata.name
    targets:
      - select:
          kind: ClusterRoleBinding
        fieldPaths:
          - subjects.*.namespace

patches:
  - target:
      kind: Deployment
      name: ml-pipeline-ui
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: METADATA_ENVOY_SERVICE_SERVICE_HOST
          value: "metadata-envoy-service"
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: METADATA_ENVOY_SERVICE_SERVICE_PORT
          value: "9090"
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          kubernetes.io/hostname: vmi3021562

  - target:
      kind: Service
      name: ml-pipeline-ui
    patch: |
      - op: replace
        path: /spec/type
        value: NodePort
      - op: replace
        path: /spec/ports/0/port
        value: 5000
      - op: replace
        path: /spec/ports/0/targetPort
        value: 3000
      - op: add
        path: /spec/ports/0/nodePort
        value: 30000

  - target:
      kind: PersistentVolumeClaim
      name: mysql-pv-claim
    patch: |
      - op: add
        path: /spec/storageClassName
        value: local-path

  - target:
      kind: PersistentVolumeClaim
      name: minio-pvc
    patch: |
      - op: add
        path: /spec/storageClassName
        value: local-path

  - target:
      kind: Deployment
      name: minio
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: minio
      spec:
        template:
          spec:
            securityContext:
              fsGroup: 1000
              runAsUser: 1000
              runAsGroup: 1000
            initContainers:
              - name: fix-permissions
                image: busybox:1.36
                command: ['sh', '-c', 'chown -R 1000:1000 /data && chmod -R 755 /data']
                securityContext:
                  runAsUser: 0
                volumeMounts:
                  - name: data
                    mountPath: /data
                    subPath: minio
            containers:
              - name: minio
                image: minio/minio:RELEASE.2024-01-16T16-07-38Z
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                  runAsNonRoot: true

  - target:
      kind: ConfigMap
      name: workflow-controller-configmap
    patch: |
      - op: add
        path: /data/workflowDefaults
        value: |
          spec:
            podSpecPatch: |
              containers:
                - name: main
                  env:
                    - name: KFP_POD_NAME
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.name
                    - name: KFP_POD_UID
                      valueFrom:
                        fieldRef:
                          fieldPath: metadata.uid
                  envFrom:
                    - configMapRef:
                        name: metadata-grpc-configmap
                        optional: true
                    - secretRef:
                        name: mlpipeline-minio-artifact
      - op: replace
        path: /data/executor
        value: |
          image: quay.io/argoproj/argoexec:v3.4.17
          imagePullPolicy: IfNotPresent

  - target:
      kind: Deployment
      name: workflow-controller
    patch: |
      - op: replace
        path: /spec/template/spec/containers/0/args
        value:
          - --configmap
          - workflow-controller-configmap
          - --executor-image
          - quay.io/argoproj/argoexec:v3.4.17
          - --namespaced
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: quay.io/argoproj/workflow-controller:v3.4.17
