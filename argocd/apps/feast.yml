# ArgoCD Application: Feast Feature Store
# Official Feast Helm chart for feature serving with UI
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: feast
  namespace: mlops-ci
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  project: mlops-infrastructure

  source:
    repoURL: https://feast-helm-charts.storage.googleapis.com
    chart: feast-feature-server
    targetRevision: 0.59.0
    helm:
      releaseName: feast
      values: |
        replicaCount: 1

        image:
          repository: feastdev/feature-server
          pullPolicy: IfNotPresent
          tag: "0.46.0"

        logLevel: "INFO"

        # Feast deployment mode: online, offline, ui, registry
        feast_mode: "ui"

        # Base64 encoded feature_store.yaml
        # Decoded config:
        #   project: mlops_features
        #   provider: local
        #   registry:
        #     path: /app/data/registry.db
        #   online_store:
        #     type: sqlite
        #     path: /app/data/online_store.db
        #   entity_key_serialization_version: 2
        feature_store_yaml_base64: "cHJvamVjdDogbWxvcHNfZmVhdHVyZXMKcHJvdmlkZXI6IGxvY2FsCnJlZ2lzdHJ5OgogIHBhdGg6IC9hcHAvZGF0YS9yZWdpc3RyeS5kYgpvbmxpbmVfc3RvcmU6CiAgdHlwZTogc3FsaXRlCiAgcGF0aDogL2FwcC9kYXRhL29ubGluZV9zdG9yZS5kYgplbnRpdHlfa2V5X3NlcmlhbGl6YXRpb25fdmVyc2lvbjogMgo="

        service:
          type: NodePort
          port: 80
          nodePort: 30060

        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

        livenessProbe:
          initialDelaySeconds: 30
          periodSeconds: 30

        readinessProbe:
          initialDelaySeconds: 20
          periodSeconds: 10

  destination:
    server: https://kubernetes.default.svc
    namespace: mlops-ml

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
