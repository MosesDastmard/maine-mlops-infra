# ArgoCD Application: Feast Feature Store
# Official Feast Helm chart for feature serving with UI
# Requires: feast-postgresql, feast-redis (deployed separately)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: feast
  namespace: mlops-ci
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  project: mlops-infrastructure

  source:
    repoURL: https://feast-helm-charts.storage.googleapis.com
    chart: feast-feature-server
    targetRevision: 0.59.0
    helm:
      releaseName: feast
      values: |
        replicaCount: 1

        image:
          repository: feastdev/feature-server
          pullPolicy: IfNotPresent
          tag: "0.46.0"

        logLevel: "INFO"

        # Feast deployment mode: online, offline, ui, registry
        feast_mode: "ui"

        # Base64 encoded feature_store.yaml
        # Decoded config:
        #   project: mlops_features
        #   provider: local
        #   registry:
        #     registry_type: sql
        #     path: postgresql://feast:***@feast-postgresql.mlops-ml.svc.cluster.local:5432/feast_registry
        #   online_store:
        #     type: redis
        #     connection_string: feast-redis-master.mlops-ml.svc.cluster.local:6379,password=***
        #   entity_key_serialization_version: 2
        feature_store_yaml_base64: "cHJvamVjdDogbWxvcHNfZmVhdHVyZXMKcHJvdmlkZXI6IGxvY2FsCnJlZ2lzdHJ5OgogIHJlZ2lzdHJ5X3R5cGU6IHNxbAogIHBhdGg6IHBvc3RncmVzcWw6Ly9mZWFzdDpNb3NlczE3NDlGZWFzdCFAZmVhc3QtcG9zdGdyZXNxbC5tbG9wcy1tbC5zdmMuY2x1c3Rlci5sb2NhbDo1NDMyL2ZlYXN0X3JlZ2lzdHJ5Cm9ubGluZV9zdG9yZToKICB0eXBlOiByZWRpcwogIGNvbm5lY3Rpb25fc3RyaW5nOiBmZWFzdC1yZWRpcy1tYXN0ZXIubWxvcHMtbWwuc3ZjLmNsdXN0ZXIubG9jYWw6NjM3OSxwYXNzd29yZD1Nb3NlczE3NDlGZWFzdFJlZGlzIQplbnRpdHlfa2V5X3NlcmlhbGl6YXRpb25fdmVyc2lvbjogMgo="

        service:
          type: NodePort
          port: 80

        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

        livenessProbe:
          initialDelaySeconds: 60
          periodSeconds: 30

        readinessProbe:
          initialDelaySeconds: 30
          periodSeconds: 10

  destination:
    server: https://kubernetes.default.svc
    namespace: mlops-ml

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
