# TimescaleDB Helm Values
# Time-series database for storing sales data from Kafka

# Using Bitnami PostgreSQL with TimescaleDB extension
global:
  security:
    allowInsecureImages: true

image:
  registry: docker.io
  repository: timescale/timescaledb-ha
  tag: pg16.11-ts2.24.0-all

# Authentication
auth:
  postgresPassword: 4k0pYu4JMcZlG8KPTimescaleAdmin!
  username: mlops
  password: 4k0pYu4JMcZlG8KPTimescale!

# Primary configuration
primary:
  service:
    type: NodePort
    nodePorts:
      postgresql: "30432"
  extraVolumes:
    - name: postgresql-run
      emptyDir: {}
  extraVolumeMounts:
    - name: postgresql-run
      mountPath: /var/run/postgresql
  persistence:
    enabled: true
    storageClass: local-path
    size: 50Gi
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "4Gi"
      cpu: "2000m"
  # TimescaleDB-specific settings
  extendedConfiguration: |
    shared_preload_libraries = 'timescaledb,pg_cron'
    cron.database_name = 'postgres'
    timescaledb.telemetry_level = 'off'
    max_connections = 200
    shared_buffers = 1GB
    effective_cache_size = 3GB
    maintenance_work_mem = 512MB
    work_mem = 32MB
    max_parallel_workers_per_gather = 2
    max_parallel_workers = 4
    wal_buffers = 64MB
    min_wal_size = 512MB
    max_wal_size = 2GB

  # Init scripts to create maine database and historical schema
  initdb:
    scripts:
      00-init-maine.sql: |
        -- Create maine database if not exists (for consumer service)
        SELECT 'CREATE DATABASE maine OWNER mlops'
        WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'maine')\gexec
      
      01-init-schema.sh: |
        #!/bin/bash
        set -e
        # Connect to maine database and create schema
        PGPASSWORD=$POSTGRES_PASSWORD psql -U mlops -d maine <<-EOSQL
          -- Enable TimescaleDB extension
          CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
          
          -- Create sales schema for sales data
          CREATE SCHEMA IF NOT EXISTS sales;
          
          -- Grant permissions
          GRANT ALL PRIVILEGES ON SCHEMA sales TO mlops;
          ALTER DEFAULT PRIVILEGES IN SCHEMA sales GRANT ALL PRIVILEGES ON TABLES TO mlops;

          -- Create sales schema for sales data
          CREATE SCHEMA IF NOT EXISTS products;
          
          -- Grant permissions
          GRANT ALL PRIVILEGES ON SCHEMA products TO mlops;
          ALTER DEFAULT PRIVILEGES IN SCHEMA products GRANT ALL PRIVILEGES ON TABLES TO mlops;

          -- Create orders schema for orders data
          CREATE SCHEMA IF NOT EXISTS orders;
          
          -- Grant permissions
          GRANT ALL PRIVILEGES ON SCHEMA orders TO mlops;
          ALTER DEFAULT PRIVILEGES IN SCHEMA orders GRANT ALL PRIVILEGES ON TABLES TO mlops;

          -- Create suppliers schema for suppliers data
          CREATE SCHEMA IF NOT EXISTS suppliers;
          
          -- Grant permissions
          GRANT ALL PRIVILEGES ON SCHEMA suppliers TO mlops;
          ALTER DEFAULT PRIVILEGES IN SCHEMA suppliers GRANT ALL PRIVILEGES ON TABLES TO mlops;


          -- Create snapshots schema for snapshots data
          CREATE SCHEMA IF NOT EXISTS snapshots;
          
          -- Grant permissions
          GRANT ALL PRIVILEGES ON SCHEMA snapshots TO mlops;
          ALTER DEFAULT PRIVILEGES IN SCHEMA snapshots GRANT ALL PRIVILEGES ON TABLES TO mlops;
        EOSQL

# Disable replication for single-node setup
architecture: standalone

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: false
